<!doctype html>
<html lang="en">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- style  css -->
<link rel="stylesheet" href="bootstrap.min.css">
<link rel="stylesheet" href="sweetalert.min.css">
<style>
body{
  font-size: 1rem;
}
.container{
  max-width: 42em;
}
.container main{
  width: 100%;
}
table{
  width: 100%;
  font-size: 0.7rem;
  border-collapse: collapse;
}
table th, td{
  padding: 0 0.5rem;
  border: 0.5px solid#ccc;
}
#thead th{
  text-align: center;
  padding: 0.3rem 0.5rem;
}
#tbody td:nth-child(2),
#tbody td:nth-child(3){
  text-align: left;
}
tbody td:nth-child(3):hover{
  color: 000;
  font-size: 1.5rem;
  background: #0f0;
  font-weight: bold;
}
#tbody th:nth-child(1),
#tbody td:nth-child(4){
  text-align: center;
}
#tbody td:nth-child(5){
  text-align: right;
}
#tfoot th{
  border: 0;
  padding: 0.5rem 0.5rem;
  text-align: right;
}
#tbody:hover{
  background: #ccc;
  font-weight: bold;
}
</style>
</head>
<body class="font-monospace" onload="readName()">
  <div class="container d-flex w-100 h-100 justify0content-center flex-column p-3">
    <header class="mb-auto">
      <div class="fw-bold fs-5 text-capitalize pb-3">Worker Absenteeism</div>
      <div class="input-group input-group-sm mb-1 w-50">
        <input type="text" class="form-control" id="keyword" list="listName" onclick="document.querySelector('#keyword').value=null"/>
        <datalist id="listName"></datalist>
        <button type="submit" class="input-group-text" onclick="srcData()"><svg xmlns="http://www.w3.org/2000/svg" height="17px" viewBox="0 -960 960 960" width="17px" fill="currentColor"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></button>
      </div>
    </header>
    <main class="m-auto">
      <div class="table-responsive"></div>
    </main>
    <footer class="mt-auto text-end">
      <button type="submit" class="btn btn-sm btn-dark px-3" onclick="addData()">Add Presence</button>
    </footer>
  </div>    
<script src="bootstrap.bundle.min.js"></script>
<script src="sweetalert.min.js"></script>
<script>
var scriptUrl = 'https://script.google.com/macros/s/AKfycbySfEt9wVvZl3uHy5eYFiqOj0yy_LqWzNU1dqzyQhAWQFFgPLO40533HrBE54mpkA_7/exec';

function srcData(){
  Swal.fire({
    title: 'Loading...',
    text: 'Please wait',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  });
  let keyword = document.querySelector('#keyword').value;
  getData(keyword);
  
}

function readName(){
  Swal.fire({
    title: 'Loading...',
    text: 'Please wait',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  });
  let div = document.querySelector("#listName");
  fetch(scriptUrl).then(response => response.json()).then(data => {
    div.innerHTML = "";
    data.workers.forEach((row)=> {
      let opt = document.createElement("option");
      opt.textContent = row.workername;
      div.appendChild(opt);
    });
    getData();
    Swal.close();
  }).catch(error => console.error(error))
}

function addData(key){
  Swal.fire({
    title: 'Add Present',
    html: `
    <div class="text-start" style="font-size:0.7rem">
    <label>Worker Name</label>
    <input type="text" id="workername" class="form-control" list="listName" value="${key ? key[0] : ''}">
    <datalist id="listName"></datalist>
    <div class="row mt-3">
    <div class="col">
    <label>Presence</label>
    <select id="presence" class="form-control text-center">
    <option>Present</option>
    <option>Unpresent</option>
    </select>
    </div><div class="col">
    <label>Cash Receipt</label>
    <input type="number" id="cashreceipt" class="form-control text-center" placeholder="Cash Receipt" value="000">
    </div></div></div>`,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: 'Simpan',
    cancelButtonText: 'Batal',
    preConfirm: () => {
      return {
        timestamp: new Date().toLocaleString('id-ID',{ weekday:'long'})+', '+new Date().toLocaleString('id-ID'),
        workername: document.getElementById('workername').value,
        presence: document.getElementById('presence').value,
        cashreceipt: document.getElementById('cashreceipt').value
      }
    }
  }).then((result) => {
    if (result.value) {
      Swal.fire({
        title: 'Loading...',
        text: 'Please wait',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });
      fetch(scriptUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `timestamp=${result.value.timestamp}&workername=${result.value.workername}&presence=${result.value.presence}&cashreceipt=${result.value.cashreceipt}`
      })
      .then(response => response.text())
      .then(data => {
        getData(result.value.workername);
        console.log(data);
      })
      .catch(error => console.error(error));
    }
  });
}

function getData(keyword){
  let div = document.querySelector(".table-responsive");
  fetch(keyword ? `${scriptUrl}?keyword=${keyword}` : scriptUrl).then(response => response.json()).then(data => {
    div.innerHTML = "";
    let table = document.createElement("table");
    let thead = table.insertRow();
    thead.id = 'thead';
    thead.innerHTML =`
    <th>No</th>
    <th>Timestamp</th>
    <th>WorkerName</th>
    <th>Presence</th>
    <th>CashReceipt</th>`;
    let totals = 0;
    data.presences.forEach((row, index)=> {
      let tbody = table.insertRow();
      tbody.id = 'tbody';
      tbody.innerHTML =`
      <th>${index+1}</th>
      <td>${row.timestamp}</td>
      <td onclick="addData(['${row.workername}'])">${row.workername}</td>
      <td>${row.presence}</td>
      <td>${row.cashreceipt}</td>`;
      totals += parseFloat(row.cashreceipt);
    });
    let tfoot = table.insertRow();
    tfoot.id = 'tfoot';
    tfoot.innerHTML =`
    <th colspan="5">${totals}</th>`;
    div.appendChild(table);
    Swal.close();
  }).catch(error => console.error(error));
}
</script>
</body>
</html>